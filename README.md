# Purview loader for Databricks, Oracle and MSSQL sources


## Overview

This document describes a small command-line based utilities provided to European Medicine Agency (EMA) for maintaining Purview through the Purview API.

**_The code is provided as "as-is" code and is Ubuntu Linux based._**

On a Windows machine access to Ubuntu can be established using WSL.

The code is based on the Purview cli interface provided through GitHub:  
[GitHub - tayganr/purviewcli: Microsoft Purview CLI](https://github.com/tayganr/purviewcli)

## Limitations

For each source - information from the "server" to the "tables" are loaded. No columns in added.

The hierarchy structure and the connection to the collection shown in the Purview Portal does not as of now.

## Initial setup

This document uses a shell prompt in Ubuntu for screen dumps.

### Requirements

It is a requirement that access to Purview using an Azure client has been established.

Hence the scripts supplied requires the following variable to be set:

- PURVIEW_NAME
- TENANT_ID
- CLIENT_ID
- CLIENT_SECRET

The value for these variables must be entered into the file setup_purview.sh

#### PURVIEW_NAME

This is the name of the purview account you want to use.

#### TENANT_ID

The TENANT_ID can be found in the Azure portal navigating to **Microsoft Entra ID** and on the Overview tab you will find this value.

#### CLIENT_ID and CLIENT_SECRET

To obtain CLIENT_ID and CLIENT_SECRET you will need to follow these steps:

- Create an Azure Active Directory Application in Microsoft Entra ID:
  - In Azure portal navigate to **Microsoft EntraID**.
  - Click on App registrations and then **New registration**.
  - Once the application is created, note down the Application (client) ID. This is your CLIENT_ID.
- Generate a Client Secret:
  - In the application settings, go to **Certificates & secrets**.
  - Under the **Client secrets** section, click **new client secret**.
  - Generated client secret is your CLIENT_SECRET - remember to copy this as instructed.

### Purview access rights

This Client-app must then be granted access to the domains in Purview.

- In the **Purview Portal** go to Data Map and then select the default domain
- In the overview section select the tab "Role assignments"
- Assign your Registered Client to the following roles in purview (clicking the "person with the plus" icon):
  - Collection Admin
  - Data Source Admin
  - Data curators
  - Data Readers

Detailed instructions can be found here  
<https://learn.microsoft.com/en-us/purview/data-gov-api-rest-data-plane#set-up-authentication-using-service-principal>

## Scripts

This document assume that are using Ubuntu using WSL in windows.

If you are using Ubuntu "clean" please change directory names accordingly.

Unzip the files provided to a directory of your preference - this document uses the name for a directory located in the root of c-drive called **purview**.

Start the ubuntu distribution using the Windows Teminal.

Change directory to /mnt/c/purview.

In this directory you will find files used by this setup. The 4 important files are:

**setup_purview.sh** - this script must be run once, and it sets up the variable described above and write them into the init_purview.sh script.  
The value for the 4 variables must be entered into the file named **parameters.txt** (see below).  
The variables are named <<VARIABLE_NAME>> and this must then be changed accordingly, including removing the << >>.

**init_purview.sh** - this file is generated by the setup_purview.sh scrips and must be run every time a new Ubuntu 
terminal is started using the command  **. ./init_purview.sh**

**load_purview.sh** - this is the main scrip used to load Purview. It required the init_purview.sh script to have been run as described. It uses a dialogue to get the values needed for the load.

**tables.csv** - to load Purview the script read a file like tables.csv (provided as an example). It is important that the structure of this file is a comma separated file with the 3 values table_schema, table_name, table_type.

**Before using the commands described in the following please issue the following command from the command prompt:**

- **chmod +x setup_purview.sh**
- **chmod +x load_purview.sh**

## Establish environment

Before running the scripts, you need to change the **parameters.txt** file and then run the script setup_purview.sh

In the **parameters.txt** file you must specify the values for PURVIEW_NAME, TENANT_ID, CLIENT_ID and CLIENT_SECRET.

The format of the init_parameters.txt file is as follows.

[parameters](images/parameters.png)

After these changes has been made the setup script must be run using the command

**./setup_purview.sh**

[setup](images/setup.png)

**Note**

If you would like this script also to install the required python files for the setup to run - instead of doing this manually - 
you can run this script using this command

**./setup_purview.sh setup**

[setup_with_lib](images/setup_libraries.png)


## Each time you open a new Ubuntu terminal

Every time the Ubuntu shell is opened the command **. ./init_purview.sh** must be issued.

**Please note that both punctuations must be entered!!!**

This command initializes the parameters to be used for connecting to the Purview account.

This command must run every time the cloud shell is activated.

## Load purview with a new "system."

To create a new placeholder for a "system" within the Purview instance you then run
the command **./load_purview.sh**

This command has a dialogue. First the connection is made to the Purview account.  

Please note that script provides default values in [] and that the default for Yes/No questions is **N**o.

Parameters that the dialogue asks for

- Name of parent collection - default is the root collection.
- Name of system - whatever name you would like to use. You cannot use "spaces" in the name, use "_" instead.
- You can choose type of system being MS Sql, Oracle or Databricks.
- The name of the file the contains the "tables" the need to be load. This name can be "anything" if that file has the right structure.

If you are satisfied with the information enter Y to continue.

[example_of_dialogue](images/load_script.png)

**NOTE:** In case you get an error, you must likely need to run the initialization command**. ./init_purview.sh**

# Cleanup procedure

Every time the load_purview script is run, and a source is created, the process registers its progress in a file called <SOURCE_NAME>_<PID>_log.sh,
where <SOURCE_NAME> is the name of the source being created, <PID>; is the process_id for the Linux process - provided for uniqueness, so that the 
same source can be loaded multiple times, for instance with different tables.

The structure of these files in so that the contains the corresponding "delete" statements using pv of what has been created.

So, if you want to delete everything from a run simply execute the file using the command ./<SOURCE_NAME>_<PID>_log.sh.

Alternatively, you can use the commands shown in the file to selective delete unwanted items.  

>[!Note]
>If the scripts is run as a complete run the sources them selves are also deleted, hence will all objects connected to those be deleted.
>Eventhough they was not load in "one go"